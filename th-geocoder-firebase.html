<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-firebase/th-firebase.html">
<link rel="import" href="../th-geocoder/th-geocoder.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <th-geocoder-firebase></th-geocoder-firebase>

@element th-geocoder-firebase
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/th-geocoder-firebase
-->
<polymer-element name="th-geocoder-firebase" attributes="input reverseGeocode firebaseDirectory firebaseLocationRequestRoute firebaseLocation output">

  <template>
    <th-firebase id="firebase" directory="{{firebaseDirectory}}" locationRequestRoute="{{firebaseLocationRequestRoute}}" location="{{firebaseLocation}}" ></th-firebase>
    <th-geocoder id="geocoder" input="{{geocodeInput}}" ></th-geocoder>
  </template>

  <script>

    Polymer({
      input: [{'address1':'1501 Lexington Avenue, New York, NY 10029', 'address2':'Columbus Circle, New York, NY'}, {'address1':'54 West 40th Street, New York, NY 10018', 'address2':'Brooklyn Bridge Park, New York, NY'},{'address1':'54 West 50th Street, New York, NY', 'address2':'Central Park, New York, NY'}], // array of objects
      reverseGeocode: false, 
      firebaseDirectory: 'geocodes/',
      ready: function() {
        var self = this;
        self.firebase = self.$.firebase;
        self.geocoder = self.$.geocoder;
  
        //TODO: figure out how to show the menu in the geocoder when the data is found in firebase (_dataAttributes needs to be set);

        // Create hash for unique identifier of input for firebase
        var input = self.input.toString(),
            inputLength = input.length;
        self.hash = 0;
          var i, chr, len;
            if (inputLength == 0) return self.hash;
            for (i = 0; i < inputLength; i++) {
              chr   = input.charCodeAt(i);
              self.hash  = ((self.hash << 5) - self.hash) + chr;
              self.hash |= 0; // Convert to 32bit integer
            }

        // Listen for geocode output ready event
        self.geocoder.addEventListener('th-output-ready', function(response) {
          console.log("data received from geocoder");
          self.output = response.detail;
          self.saveToFirebase();
        })
        
        // Setup and check firebase for input
        self.setupFirebase();
        self.checkFirebase();

      },
      setupFirebase: function(){
        var self = this;
      
        // Listen for firebase responses
        self.firebase.addEventListener('th-data-ready', function(response) {
            // Data found in firebase, so output is ready
            console.log("data received from firebase");
            console.log(response.detail)
            self.receiveFromFirebase(response.detail);
          });

        self.firebase.addEventListener('th-data-error', function(response) {
          // No data in firebase for that URL, so pass it to th-geocoder
          console.log("not found in firebase, send to geocoder");
          self.geocodeInput = self.input;
        });
      },
      checkFirebase: function(){
        var self = this;
        console.log("check firebase");
        self.firebase.load(self.hash);
      },
      saveToFirebase: function(){
        var self = this; 
        console.log("save to firebase");
        self.firebase.save(self.output, self.hash);
      },
      receiveFromFirebase: function(geocodes){
        var self = this;
        console.log("retrieved from firebase");
        self.output = geocodes;
      },
      inputChanged: function(){
        var self = this;
        console.log("input changed");
        self.checkFirebase();
      }

    });

  </script>

</polymer-element>
