<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-geocoder/th-geocoder.html">
<link rel="import" href="../th-firebase/th-firebase.html">
<link rel="import" href="../aha-table/src/aha-table.html">
<!--
Element providing solution to no problem in particular.

##### Example

    <th-geocoder-firebase></th-geocoder-firebase>

@element th-geocoder-firebase
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/th-geocoder-firebase
-->
<polymer-element name="th-geocoder-firebase" extends="th-geocoder" attributes="input reverseGeocode output firebaseLocation selectedLabel">
<template>  
  <style>
      :host {
        width: 150px;
      }
      
      core-selector {
        min-height: 10px;
        display: inline-block;
      }

      core-selector .col {
        padding: 3px;
        border: 1px solid #ccc;
      }
      core-selector .core-selected {
        background-color: #ccc;
        border: 1px solid #888;
      }

      label {
        display: block;
        color: #2fa3af;
        border-top: 1px solid #AAA;
      }

      .elTitle {
        color: #2fa3af;
        padding: 2px;
      }

      .disabled {
        color: #EEE;
      }

      .table-container {
        width: 500px;
        height: 400px;
        overflow: scroll;
        resize: both;
      }
      core-selector {
        min-height: 10px;
        display: inline-block;
        max-height: 123px;
      }

      core-selector .col {
        display: inline-block;
        margin: 0 3px;
        padding: 1px;
        border: 1px solid #EEE;
      }
      core-selector .core-selected {
        background-color: #ccc;

      }
      label {
        vertical-align: top;
      }
  </style>
  
    <th-firebase id="firebase" directory="geocodes/" locationRequestRoute="{{firebaseLocationRequestRoute}}" location="{{firebaseLocation}}" ></th-firebase>
    
    <!-- Menu for selecting input --> 
  
      <label for="label_selector">Select location column: </label> 
      <core-selector id="label_selector" selected="{{selectedLabel}}" valueattr="label">
        <template repeat="{{attr in _dataAttributes}}">
          <div label="{{attr}}" class="col">{{attr}}</div>
        </template>
      </core-selector>
    
        <p>{{firebaseOutput.length}} of {{input.length}} locations processed.</p>
        <template if="{{errors.length > 0}}">
          <p>{{errors.length}} location(s) NOT found:</p>
          <template repeat="{{error in errors}}">
            <li><strong> Location: </strong>{{error.location}} <strong> Reason: </strong>{{error.reason}}</li>
          </template>
        </template>
        
        
      </div>
    </core-collapse>
  </template>

  <script>

    Polymer({
      // input: [{'address1':'1501 Lexington Avenue, New York, NY 10029', 'address2':'Columbus Circle, New York, NY'}, {'address1':'54 West 40th Street, New York, NY 10018', 'address2':'Brooklyn Bridge Park, New York, NY'}], // array of objects
      firebaseLocation: 'https://shining-fire-6376.firebaseio.com/',
      ready: function(){
        var self = this;

        self.firebase = self.$.firebase;
        self.setupFirebase();
      },
      inputChanged:function(){
        var self = this;
        self.fire('th-input-changed', self);
        self.setupOutput();
        self.errors = [];
        self.parseInput();

        // self.hash = self.createHash(self.inputArray);

        self.checkFirebase();
      },
      selectedLabelChanged: function(){
        console.log('geocoder-firebase selection changed');
        console.log('***************');
        var self = this;
        self.firebaseOutput = [];
        self.errors = [];
        self.setupOutput();
        self.errors = [];
        if(self.input.length > 0){
          self.inputArray = self.input.map(function(obj){return obj[self.selectedLabel]});
        } else {
          self.inputArray = [self.input[self.selectedLabel]];
        }

        self.hash = self.createHash(self.inputArray);
        self.checkFirebase();

      },
      setupFirebase: function(){
        console.log('setup firebase');
        var self = this;
        
        // Listen for firebase responses
        self.firebase.addEventListener('th-data-ready', function(response) {
            // Data found in firebase, so output is ready
            console.log("data received from firebase");
            self.mapOutputFromFirebase(response.detail);
          });

        self.firebase.addEventListener('th-data-error', function(response) {
          // No data in firebase for that URL, so pass it to th-geocoder
          console.log("not found in firebase, request from geocode API");
          self.getLocations();
        });
      },
      createHash: function(input){
        console.log('create hash');
        var input = input.toString(),
            inputLength = input.length;
        
        var hash = 0;
          var i, chr, len;
            if (inputLength == 0) return hash;
            for (i = 0; i < inputLength; i++) {
              chr   = input.charCodeAt(i);
              hash  = ((hash << 5) - hash) + chr;
              hash |= 0; // Convert to 32bit integer
            }
            
        return hash;
      },
      checkFirebase: function(){
        console.log('check firebase');
        var self = this;
        self.firebase.load(self.hash);
      },
      saveToFirebase: function(){
        var self = this;
        console.log("save geocodes to firebase");
        self.firebase.save(self.firebaseOutput, self.hash);
      },
      firebaseOutputChanged: function(){
        var self = this;
        if (self.firebaseOutput.length === self.inputArray.length){
          self.saveToFirebase();
        }
      },
      mapOutputFromFirebase: function(geocodesArr){
        console.log("combine firebase result with input data")
        var self = this;
        self.firebaseOutput = geocodesArr;
        self.errors=[];
        self.output = self.input.map(function(item){
          var newItem = {},
              keys = Object.keys(item);
          keys.forEach(function(key) {
            newItem[key] = item[key];
          })
          geocodesArr.forEach(function(geocode){
            if(geocode.input === item[self.selectedLabel]){
              newItem.latitude = geocode.latitude;
              newItem.longitude = geocode.longitude;
              if(geocode.errors){
                self.errors.push(geocode.errors);
                // save errors to firebaseOutput
              }
            }

          })
          return newItem;

        })
      },
      outputChanged: function(){
        var self = this;
        self.fire('th-output-changed', self);
        // When output is ready, fire event for other components to use
        if (self.output.length === self.inputLength){
          if(self.output[self.output.length-1]['latitude'] && self.output[self.output.length-1]['longitude']){
          console.log('geocoder output ready');
          self.fire('th-output-ready', self.output)
          }
        }
      }    
    });

  </script>

</polymer-element>
;