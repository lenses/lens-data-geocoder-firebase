<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../th-geocoder/th-geocoder.html">
<link rel="import" href="../th-firebase/th-firebase.html">
<!--
Element providing solution to no problem in particular.

##### Example

    <th-geocoder-firebase></th-geocoder-firebase>

@element th-geocoder-firebase
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://polymerlabs.github.io/th-geocoder-firebase
-->
<polymer-element name="th-geocoder-firebase" extends="th-geocoder" attributes="input reverseGeocode output firebaseLocation">
<template>
  
    <th-firebase id="firebase" directory="geocodes/" locationRequestRoute="{{firebaseLocationRequestRoute}}" location="{{firebaseLocation}}" ></th-firebase>
    
    <!-- Menu for selecting input --> 
    <core-icon-button icon="perm-data-setting" on-click="{{showControls}}"></core-icon-button>
    <core-collapse id="ctrl_collapse">      
      <label for="label_selector">Select label column: </label> 
      <core-selector id="label_selector" selected="{{_selectedLabel}}" valueattr="label">
        <template repeat="{{attr in _dataAttributes}}">
          <div label="{{attr}}">{{attr}}</div>
        </template>
      </core-selector>
    </core-collapse>
    
    <p>{{errors.length}} location(s) NOT found:</p>
    <template repeat="{{error in errors}}">
      <li>Location: {{error.location}}, reason: {{error.reason}}</li>
    </template>

    <p>{{output.length}} location(s) found:</p>
    <template repeat="{{place in output}}">
      <li>{{place.label}}: ({{place.latitude}}, {{place.longitude}})</li>
    </template>
  </template>
    
  </template>

  <script>

    Polymer({
      // input: 'New York, NY', // string
      // input: ['1501 Lexington Avenue, New York, NY 10029', '54 West 40th Street, New York, NY 10018'], // array
      // input: '40.7863301, -73.95027060000001', // coordinates for reverseGeocode => set reverseGeocode = true;
      // input: [{'address1':'1501 Lexington Avenue, New York, NY 10029', 'address2':'Columbus Circle, New York, NY'}, {'address1':'54 West 40th Street, New York, NY 10018', 'address2':'Brooklyn Bridge Park, New York, NY'}], // array of objects
      // input: {'address': '1501 Lexington Avenue, New York, NY 10029' }, // object
      getLocations: function(){
        var self = this,
            inputLength = self.inputArray.length,
            i = 0;
        
        self.firebase = self.$.firebase;

        // Listen for firebase responses
        self.firebase.addEventListener('th-data-ready', function(response) {
            // Data found in firebase, so output is ready
            console.log("data received from firebase");
            self.output = response.detail;
          });

        self.firebase.addEventListener('th-data-error', function(response) {
          // No data in firebase for that URL, so pass it to th-geocoder
          console.log("not found in firebase, request from geocode API");
          var interval = setInterval(function(){
              self.geocodeFunc(self.inputArray[i], self.output);
              i++;
              if(i === inputLength) {
                clearInterval(interval);
              }
          }, 300); 
          
        });
        
        self.hash = self.createHash(self.inputArray);
        self.checkFirebase();
      },
      createHash: function(input){
        var input = input.toString(),
            inputLength = input.length;
        
        var hash = 0;
          var i, chr, len;
            if (inputLength == 0) return hash;
            for (i = 0; i < inputLength; i++) {
              chr   = input.charCodeAt(i);
              hash  = ((hash << 5) - hash) + chr;
              hash |= 0; // Convert to 32bit integer
            }
            
        return hash;
      },
      checkFirebase: function(){
        var self = this;
        console.log("check firebase for geocodes");
        self.firebase.load(self.hash);
      },
      saveToFirebase: function(){
        var self = this;
        console.log("save geocodes to firebase");
        self.firebase.save(self.output, self.hash);
      },
      outputChanged: function(){
        var self = this;
        // When output is ready, fire event for other components to use
        if ((self.output.length + self.errors.length) >= self.inputLength){
          self.fire('th-output-ready', self.output)
          console.log("save geocodes to firebase");
          self.saveToFirebase();
        }
        self.displayErrors();
      }
    });

  </script>

</polymer-element>
